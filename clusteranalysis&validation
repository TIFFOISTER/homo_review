library(easypackages)  
libraries('dplyr', 'tidyverse', 'cluster', 'NbClust', 'ggplot2', 'vegan', 'fpc', 'ape', 'dendextend', 'RColorBrewer')  
#load matrix - create stripped down version #
skinnycorpus <- read.csv('./skinnycorpus.csv') 
corp<- skinnycorpus %>% select(-('title'))  
corp<- corp %>% select(-('proxy'))  
corp<- corp %>% select(-('method')) 
corp<- corp %>% select(-('country_codes'))   
corp <- select(corp,2:125)
# location version + proxy/method version #
##ID <- skinnycorpus %>%select('paperid')
##location <- skinnycorpus %>% select('country_codes')
##proxy <- skinnycorpus %>% select('proxy')
##method <- skinnycorpus %>% select('method')
##loccorp <- bind_cols(ID, location) 
##methcorp <- bind_cols(ID, proxy, method) 
#observations only
corp2 <- corp[,2:124]  
## blank row got added corp2 <- corp2[-c(124),] = to remove##

## jaccard x agnes ##  
row.names(corp2)<- corp$paperid 
jacc.dist <- vegdist(corp2, method='jaccard') 
aggl.clust.w <- hclust(jacc.dist, method = 'ward.D')
plot(aggl.clust.w, main = 'Agglomerative, complete linkages')  
##agnes <- agnes(jacc.dist, metric = 'jaccard', method = 'ward')
##plot(agnes)  
row.names(corp2) <- tolower(row.names(corp2)) 
corp2.scaled <- scale(corp2)
plot(aggl.clust.w, hang= -1, cex =.5, main = 'average linkage clustering')
nc <- NbClust(corp2.scaled, diss=jacc.dist, distance= NULL, min.nc = 2, max.nc = 10,method = 'ward.D')  
table(nc$Best.n[1,])  
barplot(table(nc$Best.n[1,]), 
        xlab = 'Number of Clusters', ylab = 'Number of Criteria', 
        main = 'Number of Clusters Chosen')

clusters2 <- cutreeord(aggl.clust.w,k=2)
table(clusters2) 
# clusters2
#1  2 
#67 56 
cluster2.ts <- aggregate(corp2, by=list(cluster=clusters2),sum)
aggregate(as.data.frame(corp2.scaled), by=list(cluster=clusters2), sum) 
plot(aggl.clust.w, hang=-1, cex=.5, main='Average Linkage Clustering/ n2 cluster solution') 
rect.hclust(aggl.clust.w, k=2)
 ## 8 clusters ## 
clusters8 <- cutreeord(aggl.clust.w,k=8)
table(clusters8)  
#clusters8
#1  2  3  4  5  6  7  8 
#5 18 20 24 17  6  6 27
cluster8.ts <- aggregate(corp2, by=list(cluster=clusters8),sum)
aggregate(as.data.frame(corp2.scaled), by=list(cluster=clusters8), sum) 
plot(aggl.clust.w, hang=-1, cex=.5, main='Average Linkage Clustering/ n8 cluster solution') 
rect.hclust(aggl.clust.w, k=8)
 
write.csv(cluster2.ts,file='./cluster2terms.csv') 
write.csv(cluster8.ts,file='./cluster8terms.csv') 
 
# cluster validation#  
##circle plots## 
colours <- brewer.pal(8,'Set3')  
op = par(mar=c(2,2,2,2))
op = par(bg='black') 
plot(as.phylo(aggl.clust.w), type = 'fan',  
     cex = .8,label.offset = 0.1,
     tip.color = colours[clusters8], edge.color = 'white')
plot(as.phylo(aggl.clust.w), type = 'fan',  
     cex = .8, label.offset = 0.1,
     tip.color = colours[clusters2], edge.color = 'white')
## need to fix cut off of labels ## 
clust.tib8 <- as_tibble(clusters8) 
row.names(clust.tib8)<- corp$paperid 
clust.tib2 <- as_tibble(clusters2) 
row.names(clust.tib2)<- corp$paperid  
corp.clusts <- skinnycorpus[,3:6] 
corp.clusts<- cbind(corp.clusts, clust.tib2, clust.tib8) 
colnames(corp.clusts)[5]<- 'clusters2' 
colnames(corp.clusts)[6]<- 'clusters8'
write.csv(corp.clusts,file='./clustercorpus.csv')
## clustering analysis/validation ## 
#bootstraps#
cboot.8 <- clusterboot(jacc.dist, clustermethod=disthclustCBI, method = 'ward.D', k=8)
cboot.2 <- clusterboot(jacc.dist, clustermethod=disthclustCBI, method = 'ward.D', k=2)
